<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600" width="800" height="600">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
    </marker>
    <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4A90D9"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="800" height="600" fill="#fafafa"/>

  <!-- Title -->
  <text x="400" y="30" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="bold" fill="#333">bc_gitops Architecture</text>

  <!-- Git Repository (External) -->
  <rect x="30" y="80" width="140" height="80" rx="8" fill="#f5f5f5" stroke="#999" stroke-width="2"/>
  <text x="100" y="110" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#666">Git Repository</text>
  <text x="100" y="130" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#888">apps/</text>
  <text x="100" y="145" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#888">├── app_a/</text>

  <!-- bc_gitops_sup box -->
  <rect x="220" y="60" width="540" height="480" rx="10" fill="none" stroke="#4A90D9" stroke-width="2" stroke-dasharray="5,5"/>
  <text x="240" y="85" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#4A90D9">bc_gitops_sup (supervisor)</text>

  <!-- bc_gitops_reconciler box -->
  <rect x="250" y="100" width="480" height="320" rx="8" fill="#E8F4FD" stroke="#4A90D9" stroke-width="2"/>
  <text x="270" y="125" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#333">bc_gitops_reconciler (gen_server)</text>

  <!-- Reconcile Loop Steps -->
  <!-- Step 1: Pull Git -->
  <rect x="280" y="150" width="100" height="50" rx="6" fill="#fff" stroke="#666" stroke-width="1.5"/>
  <text x="330" y="170" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#333">1. Pull</text>
  <text x="330" y="185" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666">Git</text>

  <!-- Step 2: Parse Specs -->
  <rect x="410" y="150" width="100" height="50" rx="6" fill="#fff" stroke="#666" stroke-width="1.5"/>
  <text x="460" y="170" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#333">2. Parse</text>
  <text x="460" y="185" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666">Specs</text>

  <!-- Step 3: Diff State -->
  <rect x="540" y="150" width="100" height="50" rx="6" fill="#fff" stroke="#666" stroke-width="1.5"/>
  <text x="590" y="170" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#333">3. Diff</text>
  <text x="590" y="185" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666">State</text>

  <!-- Step 4: Apply Actions -->
  <rect x="410" y="230" width="100" height="50" rx="6" fill="#fff" stroke="#666" stroke-width="1.5"/>
  <text x="460" y="250" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#333">4. Apply</text>
  <text x="460" y="265" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#666">Actions</text>

  <!-- Arrows between steps -->
  <line x1="380" y1="175" x2="405" y2="175" stroke="#666" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <line x1="510" y1="175" x2="535" y2="175" stroke="#666" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <path d="M 590 200 L 590 220 L 515 220 L 515 225" fill="none" stroke="#666" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Module boxes below steps -->
  <!-- bc_gitops_git -->
  <rect x="280" y="310" width="100" height="40" rx="4" fill="#FFF3E0" stroke="#FF9800" stroke-width="1.5"/>
  <text x="330" y="335" text-anchor="middle" font-family="monospace" font-size="10" fill="#E65100">bc_gitops_git</text>

  <!-- bc_gitops_parser -->
  <rect x="410" y="310" width="100" height="40" rx="4" fill="#FFF3E0" stroke="#FF9800" stroke-width="1.5"/>
  <text x="460" y="335" text-anchor="middle" font-family="monospace" font-size="10" fill="#E65100">bc_gitops_parser</text>

  <!-- Runtime Module -->
  <rect x="540" y="310" width="100" height="40" rx="4" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1.5"/>
  <text x="590" y="328" text-anchor="middle" font-family="monospace" font-size="10" fill="#2E7D32">runtime_module</text>
  <text x="590" y="342" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">(user-provided)</text>

  <!-- Arrows from steps to modules -->
  <line x1="330" y1="200" x2="330" y2="305" stroke="#FF9800" stroke-width="1" stroke-dasharray="4,2" marker-end="url(#arrowhead)"/>
  <line x1="460" y1="200" x2="460" y2="305" stroke="#FF9800" stroke-width="1" stroke-dasharray="4,2" marker-end="url(#arrowhead)"/>
  <line x1="460" y1="280" x2="560" y2="305" stroke="#4CAF50" stroke-width="1" stroke-dasharray="4,2" marker-end="url(#arrowhead)"/>

  <!-- State boxes -->
  <!-- Desired State -->
  <rect x="280" y="370" width="120" height="60" rx="6" fill="#E3F2FD" stroke="#2196F3" stroke-width="1.5"/>
  <text x="340" y="395" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1565C0">Desired State</text>
  <text x="340" y="415" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666">(from Git repo)</text>

  <!-- Current State -->
  <rect x="520" y="370" width="120" height="60" rx="6" fill="#F3E5F5" stroke="#9C27B0" stroke-width="1.5"/>
  <text x="580" y="395" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#7B1FA2">Current State</text>
  <text x="580" y="415" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#666">(from Runtime)</text>

  <!-- Arrow from Git to reconciler -->
  <line x1="170" y1="120" x2="275" y2="175" stroke="#666" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Telemetry output -->
  <rect x="250" y="450" width="140" height="45" rx="6" fill="#fff" stroke="#607D8B" stroke-width="1.5"/>
  <text x="320" y="470" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#455A64">Telemetry Events</text>
  <text x="320" y="485" text-anchor="middle" font-family="monospace" font-size="8" fill="#78909C">[bc_gitops, ...]</text>

  <!-- OTP Applications (managed) -->
  <rect x="550" y="450" width="180" height="80" rx="8" fill="#ECEFF1" stroke="#607D8B" stroke-width="1.5"/>
  <text x="640" y="475" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#455A64">Managed Applications</text>
  <g transform="translate(570, 490)">
    <rect width="45" height="30" rx="4" fill="#fff" stroke="#90A4AE"/>
    <text x="22" y="20" text-anchor="middle" font-family="monospace" font-size="8" fill="#546E7A">app_a</text>
  </g>
  <g transform="translate(625, 490)">
    <rect width="45" height="30" rx="4" fill="#fff" stroke="#90A4AE"/>
    <text x="22" y="20" text-anchor="middle" font-family="monospace" font-size="8" fill="#546E7A">app_b</text>
  </g>
  <g transform="translate(680, 490)">
    <rect width="40" height="30" rx="4" fill="#fff" stroke="#90A4AE"/>
    <text x="20" y="20" text-anchor="middle" font-family="monospace" font-size="8" fill="#546E7A">...</text>
  </g>

  <!-- Arrow from runtime to apps -->
  <line x1="590" y1="350" x2="620" y2="445" stroke="#4CAF50" stroke-width="1.5" marker-end="url(#arrowhead)"/>

  <!-- Legend -->
  <g transform="translate(30, 500)">
    <text x="0" y="0" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#333">Legend:</text>
    <rect x="0" y="10" width="12" height="12" fill="#FFF3E0" stroke="#FF9800"/>
    <text x="18" y="20" font-family="Arial, sans-serif" font-size="9" fill="#666">Internal module</text>
    <rect x="0" y="30" width="12" height="12" fill="#E8F5E9" stroke="#4CAF50"/>
    <text x="18" y="40" font-family="Arial, sans-serif" font-size="9" fill="#666">User-provided</text>
    <rect x="0" y="50" width="12" height="12" fill="#E8F4FD" stroke="#4A90D9"/>
    <text x="18" y="60" font-family="Arial, sans-serif" font-size="9" fill="#666">Reconciler</text>
  </g>

  <!-- Reconcile interval indicator -->
  <g transform="translate(670, 100)">
    <path d="M 0 0 A 20 20 0 1 1 0 40 A 20 20 0 1 1 0 0" fill="none" stroke="#4A90D9" stroke-width="2"/>
    <path d="M 0 5 L 0 20 L 10 15" fill="none" stroke="#4A90D9" stroke-width="2"/>
    <text x="30" y="25" font-family="Arial, sans-serif" font-size="9" fill="#4A90D9">every 60s</text>
  </g>
</svg>
