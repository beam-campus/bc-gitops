<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 550" width="800" height="550">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
    </marker>
    <marker id="arrow-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4CAF50"/>
    </marker>
    <marker id="arrow-red" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#F44336"/>
    </marker>
    <marker id="arrow-purple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#9C27B0"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="800" height="550" fill="#fafafa"/>

  <!-- Title -->
  <text x="400" y="30" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="bold" fill="#333">Hot Code Reload Flow</text>
  <text x="400" y="50" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#666">bc_gitops_hot_reload module (for same-version changes)</text>

  <!-- Main flow area -->
  <rect x="50" y="70" width="700" height="400" rx="10" fill="none" stroke="#4A90D9" stroke-width="2" stroke-dasharray="5,5"/>
  <text x="70" y="95" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#4A90D9">upgrade_app(App, OldVsn, NewVsn)</text>

  <!-- Step 1: Get Modules -->
  <rect x="80" y="120" width="140" height="60" rx="8" fill="#E3F2FD" stroke="#2196F3" stroke-width="2"/>
  <text x="150" y="145" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1565C0">1. Get Modules</text>
  <text x="150" y="165" text-anchor="middle" font-family="monospace" font-size="9" fill="#666">get_app_modules/1</text>

  <!-- Step 2: Get Processes -->
  <rect x="250" y="120" width="140" height="60" rx="8" fill="#E3F2FD" stroke="#2196F3" stroke-width="2"/>
  <text x="320" y="145" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1565C0">2. Get Processes</text>
  <text x="320" y="165" text-anchor="middle" font-family="monospace" font-size="9" fill="#666">get_app_processes/1</text>

  <!-- Arrow 1->2 -->
  <line x1="220" y1="150" x2="245" y2="150" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Step 3: Suspend -->
  <rect x="420" y="120" width="140" height="60" rx="8" fill="#FFF3E0" stroke="#FF9800" stroke-width="2"/>
  <text x="490" y="145" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#E65100">3. Suspend</text>
  <text x="490" y="165" text-anchor="middle" font-family="monospace" font-size="9" fill="#666">sys:suspend/1</text>

  <!-- Arrow 2->3 -->
  <line x1="390" y1="150" x2="415" y2="150" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Step 4: Find Changed -->
  <rect x="590" y="120" width="140" height="60" rx="8" fill="#E3F2FD" stroke="#2196F3" stroke-width="2"/>
  <text x="660" y="145" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1565C0">4. Find Changed</text>
  <text x="660" y="165" text-anchor="middle" font-family="monospace" font-size="9" fill="#666">module_changed/1</text>

  <!-- Arrow 3->4 -->
  <line x1="560" y1="150" x2="585" y2="150" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Step 5: Reload Modules (center of flow) -->
  <rect x="330" y="220" width="180" height="70" rx="8" fill="#F3E5F5" stroke="#9C27B0" stroke-width="2"/>
  <text x="420" y="245" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#7B1FA2">5. Reload Modules</text>
  <text x="420" y="265" text-anchor="middle" font-family="monospace" font-size="9" fill="#666">code:soft_purge/1</text>
  <text x="420" y="280" text-anchor="middle" font-family="monospace" font-size="9" fill="#666">code:load_file/1</text>

  <!-- Arrow 4->5 -->
  <path d="M 660 180 L 660 210 L 515 210 L 515 215" fill="none" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Decision diamond: Success? -->
  <polygon points="420,320 480,355 420,390 360,355" fill="#FFF8E1" stroke="#FFC107" stroke-width="2"/>
  <text x="420" y="360" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#F57F17">Success?</text>

  <!-- Arrow 5->decision -->
  <line x1="420" y1="290" x2="420" y2="315" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Success path: Resume -->
  <rect x="530" y="325" width="140" height="60" rx="8" fill="#E8F5E9" stroke="#4CAF50" stroke-width="2"/>
  <text x="600" y="350" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#2E7D32">6a. Resume</text>
  <text x="600" y="370" text-anchor="middle" font-family="monospace" font-size="9" fill="#666">sys:resume/1</text>

  <!-- Arrow decision->resume (yes) -->
  <line x1="480" y1="355" x2="525" y2="355" stroke="#4CAF50" stroke-width="2" marker-end="url(#arrow-green)"/>
  <text x="500" y="348" font-family="Arial, sans-serif" font-size="9" fill="#4CAF50">yes</text>

  <!-- Failure path: Restart -->
  <rect x="170" y="325" width="140" height="60" rx="8" fill="#FFEBEE" stroke="#F44336" stroke-width="2"/>
  <text x="240" y="350" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#C62828">6b. Restart</text>
  <text x="240" y="370" text-anchor="middle" font-family="monospace" font-size="9" fill="#666">remove + deploy</text>

  <!-- Arrow decision->restart (no) -->
  <line x1="360" y1="355" x2="315" y2="355" stroke="#F44336" stroke-width="2" marker-end="url(#arrow-red)"/>
  <text x="340" y="348" font-family="Arial, sans-serif" font-size="9" fill="#F44336">no</text>

  <!-- code_change callback box -->
  <rect x="530" y="410" width="140" height="45" rx="6" fill="#fff" stroke="#4CAF50" stroke-width="1.5"/>
  <text x="600" y="430" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#2E7D32">code_change/3</text>
  <text x="600" y="445" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#666">callback triggered</text>

  <!-- Arrow resume->code_change -->
  <line x1="600" y1="385" x2="600" y2="405" stroke="#4CAF50" stroke-width="1" stroke-dasharray="4,2" marker-end="url(#arrow-green)"/>

  <!-- Process boxes showing suspend/resume -->
  <g transform="translate(80, 210)">
    <rect width="120" height="120" rx="6" fill="#ECEFF1" stroke="#607D8B" stroke-width="1.5"/>
    <text x="60" y="20" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#455A64">Processes</text>

    <!-- Process icons -->
    <g transform="translate(15, 35)">
      <circle cx="15" cy="15" r="12" fill="#FFF3E0" stroke="#FF9800" stroke-width="1.5"/>
      <text x="15" y="19" text-anchor="middle" font-family="monospace" font-size="8" fill="#E65100">P1</text>
      <text x="15" y="40" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#888">suspended</text>
    </g>
    <g transform="translate(55, 35)">
      <circle cx="15" cy="15" r="12" fill="#FFF3E0" stroke="#FF9800" stroke-width="1.5"/>
      <text x="15" y="19" text-anchor="middle" font-family="monospace" font-size="8" fill="#E65100">P2</text>
      <text x="15" y="40" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#888">suspended</text>
    </g>
    <g transform="translate(35, 75)">
      <circle cx="15" cy="15" r="12" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1.5"/>
      <text x="15" y="19" text-anchor="middle" font-family="monospace" font-size="8" fill="#2E7D32">P3</text>
      <text x="15" y="40" text-anchor="middle" font-family="Arial, sans-serif" font-size="7" fill="#888">not gen_*</text>
    </g>
  </g>

  <!-- Module comparison box -->
  <g transform="translate(590, 210)">
    <rect width="130" height="90" rx="6" fill="#ECEFF1" stroke="#607D8B" stroke-width="1.5"/>
    <text x="65" y="18" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#455A64">MD5 Compare</text>

    <text x="10" y="38" font-family="monospace" font-size="8" fill="#666">old: a1b2c3...</text>
    <text x="10" y="53" font-family="monospace" font-size="8" fill="#666">new: d4e5f6...</text>
    <text x="10" y="75" font-family="Arial, sans-serif" font-size="9" fill="#9C27B0">changed = true</text>
  </g>

  <!-- Legend -->
  <g transform="translate(50, 490)">
    <text x="0" y="0" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#333">Key Functions:</text>
    <text x="0" y="18" font-family="monospace" font-size="9" fill="#666">upgrade_app/3</text>
    <text x="100" y="18" font-family="Arial, sans-serif" font-size="9" fill="#888">- Main entry point</text>
    <text x="0" y="33" font-family="monospace" font-size="9" fill="#666">reload_module/1</text>
    <text x="100" y="33" font-family="Arial, sans-serif" font-size="9" fill="#888">- Single module reload</text>
    <text x="0" y="48" font-family="monospace" font-size="9" fill="#666">reload_changed_modules/1</text>
    <text x="160" y="48" font-family="Arial, sans-serif" font-size="9" fill="#888">- Detect &amp; reload changes</text>
  </g>

  <!-- Notes -->
  <g transform="translate(450, 490)">
    <text x="0" y="0" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#333">Notes:</text>
    <text x="0" y="18" font-family="Arial, sans-serif" font-size="9" fill="#666">- Only gen_server/gen_statem/gen_event are suspended</text>
    <text x="0" y="33" font-family="Arial, sans-serif" font-size="9" fill="#666">- Resuming triggers code_change/3 callback</text>
    <text x="0" y="48" font-family="Arial, sans-serif" font-size="9" fill="#666">- Falls back to restart if reload fails</text>
  </g>
</svg>
